M64 file format documentation.

# M64 File Format

Reference links:

- [Revision 18](https://tasvideos.org/EmulatorResources/Mupen/M64?revision=18):
  docs referenced at the time of writing this page.
- [Latest][m64_docs]: the latest docs for the Mupen64 movie file.

Note that future changes to the docs may not yet be implemented in this crate.
You are welcome to open an issue or a pull request if you find any discrepancies.

## File Header Format

Below is a listing of the Mupen64 movie file header format.

| Offset | Size (byte) | Type             | Endianness | Name              | Description                                                                                                                             |
| ------ | ----------- | ---------------- | ---------- | ----------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| 0x000  | 4           | -                | -          | File signature    | 4D 36 34 1A ("M64\x1A")                                                                                                                 |
| 0x004  | 4           | integer          | little     | Version number    | Should be 3                                                                                                                             |
| 0x008  | 4           | unsigned integer | little     | Movie UID         | Recording time in Unix epoch format                                                                                                     |
| 0x00C  | 4           | unsigned integer | -          | Frame count       | Number of frames (vertical interrupts)                                                                                                  |
| 0x010  | 4           | unsigned integer | -          | Rerecord count    | Number of rerecords                                                                                                                     |
| 0x014  | 1           | unsigned integer | -          | Frames per sec    | Frames (vertical interrupts) per second                                                                                                 |
| 0x015  | 1           | unsigned integer | -          | Controllers       | Number of controllers                                                                                                                   |
| 0x016  | 1           | unsigned integer | -          | Extended version  | Extended version number (should be 0 and reserved for movies created with mupen <1.1.9)                                                 |
| 0x017  | 1           | unsigned integer | -          | Extended flags    | Extended flags, only valid if the extended version number is non-0.                                                                     |
|        |             |                  |            |                   | **bit 1**: whether the movie was recorded with the WiiVC emulation mode (valid on following extended version numbers: 1)                |
|        |             |                  |            |                   | **rest**: reserved                                                                                                                      |
| 0x018  | 4           | unsigned integer | little     | Input samples     | Number of input samples for any controllers                                                                                             |
| 0x01C  | 2           | unsigned integer | -          | Movie start type  | Movie start type:                                                                                                                       |
|        |             |                  |            |                   | **value 1**: movie begins from snapshot (the snapshot will be loaded from an external file with the movie filename and a .st extension) |
|        |             |                  |            |                   | **value 2**: movie begins from power-on                                                                                                 |
|        |             |                  |            |                   | **value 4**: movie begins from EEPROM                                                                                                   |
|        |             |                  |            |                   | **other values**: invalid movie                                                                                                         |
| 0x01E  | 2           | unsigned integer | -          | Reserved          | Reserved, should be 0                                                                                                                   |
| 0x020  | 4           | unsigned integer | -          | Controller flags  | Controller flags:                                                                                                                       |
|        |             |                  |            |                   | **bit 0**: controller 1 present                                                                                                         |
|        |             |                  |            |                   | **bit 1**: controller 2 present                                                                                                         |
|        |             |                  |            |                   | **bit 2**: controller 3 present                                                                                                         |
|        |             |                  |            |                   | **bit 3**: controller 4 present                                                                                                         |
|        |             |                  |            |                   | **bit 4**: controller 1 has mempak                                                                                                      |
|        |             |                  |            |                   | **bit 5**: controller 2 has mempak                                                                                                      |
|        |             |                  |            |                   | **bit 6**: controller 3 has mempak                                                                                                      |
|        |             |                  |            |                   | **bit 7**: controller 4 has mempak                                                                                                      |
|        |             |                  |            |                   | **bit 8**: controller 1 has rumblepak                                                                                                   |
|        |             |                  |            |                   | **bit 9**: controller 2 has rumblepak                                                                                                   |
|        |             |                  |            |                   | **bit 10**: controller 3 has rumblepak                                                                                                  |
|        |             |                  |            |                   | **bit 11**: controller 4 has rumblepak                                                                                                  |
|        |             |                  |            |                   | **rest**: should be zero                                                                                                                |
| 0x024  | 32          | struct           | -          | Extended data     | Extended data, only valid if the extended version number is non-0                                                                       |
|        |             |                  |            |                   | **4-byte unsigned int**: special authorship information                                                                                 |
|        |             |                  |            |                   | **4-byte unsigned int**: additional data regarding bruteforcing                                                                         |
|        |             |                  |            |                   | **4-byte unsigned int**: high word of the rerecord count                                                                                |
|        |             |                  |            |                   | **rest**: reserved                                                                                                                      |
| 0x044  | 128         |                  | -          | Reserved          | Reserved, should be 0                                                                                                                   |
| 0x0C4  | 32          | ASCII string     | -          | Internal ROM name | Internal name of ROM used when recording, directly from ROM                                                                             |
| 0x0E4  | 4           | unsigned integer | -          | ROM CRC32         | CRC32 of ROM used when recording, directly from ROM                                                                                     |
| 0x0E8  | 2           | unsigned integer | -          | Country code      | Country code of ROM used when recording, directly from ROM                                                                              |
| 0x0EA  | 56          |                  | -          | Reserved          | Reserved, should be 0                                                                                                                   |
| 0x122  | 64          | ASCII string     | -          | Video plugin name | Name of video plugin used when recording, directly from plugin                                                                          |
| 0x162  | 64          | ASCII string     | -          | Sound plugin name | Name of sound plugin used when recording, directly from plugin                                                                          |
| 0x1A2  | 64          | ASCII string     | -          | Input plugin name | Name of input plugin used when recording, directly from plugin                                                                          |
| 0x1E2  | 64          | ASCII string     | -          | RSP plugin name   | Name of RSP plugin used when recording, directly from plugin                                                                            |
| 0x222  | 222         | UTF-8 string     | -          | Author name info  | Author name info                                                                                                                        |
| 0x300  | 256         | UTF-8 string     | -          | Movie description | Author movie description info                                                                                                           |

## Controller Data Format

Controller data starts at offset 0x400, unless the header version is 1 or 2,
which is unsupported by this crate. If you require this use case, please open an
issue or a pull request. Additional information about the controller data can be
found in the [documentation][m64_docs].

Controller data is stored as an 4-byte bitvectors. Each controller is
interleaved, though the order of the controllers is determined by the game used
in the recording.

| Sign     | Size (bits) | Name                  |
| -------- | ----------- | --------------------- |
| unsigned | 1           | Right directional pad |
| unsigned | 1           | Left directional pad  |
| unsigned | 1           | Down directional pad  |
| unsigned | 1           | Up directional pad    |
| unsigned | 1           | Start button          |
| unsigned | 1           | Z trigger             |
| unsigned | 1           | B button              |
| unsigned | 1           | A button              |
| unsigned | 1           | Right C button        |
| unsigned | 1           | Left C button         |
| unsigned | 1           | Down C button         |
| unsigned | 1           | Up C button           |
| unsigned | 1           | Right trigger         |
| unsigned | 1           | Left trigger          |
| unsigned | 1           | Reserved1             |
| unsigned | 1           | Reserved2             |
| signed   | 8           | X axis                |
| signed   | 8           | Y axis                |

In this crate, each 1-bit button value is represented using a [`bool`]. Each
8-bit axis value is represented using a [`u8`] (0..=255), but getter/setter
methods expose them [`i8`] (-128..=127). The controller data is stored in
a [`Vec`] of [`ControllerState`][`crate::m64::ControllerState`] structs on
[`Movie::inputs`][`crate::m64::Movie::inputs`], which contain the button and
axis values for each controller. Note that the y-axis is inverted, meaning that
positive ([`i8`]) values indicate downward movement on the analog stick.

[m64_docs]: https://tasvideos.org/EmulatorResources/Mupen/M64 "M64 File Format Documentation"
